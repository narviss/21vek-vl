Collections.page.UpdateCategory=function(config){config=config||{record:{}};config.record=config.record||{};Ext.applyIf(config,{panelXType:'collections-panel-category'});config.canDelete=false;Collections.page.UpdateCategory.superclass.constructor.call(this,config);};Ext.extend(Collections.page.UpdateCategory,MODx.page.UpdateResource,{getButtons:function(cfg){var btns=[];if(cfg.canSave==1){btns.push({process:MODx.config.connector_url?'resource/update':'update',text:_('save'),method:'remote',checkDirty:false,id:'modx-abtn-save',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]});btns.push('-');}else if(cfg.locked){btns.push({text:cfg.lockedText||_('locked'),handler:Ext.emptyFn,id:'modx-abtn-locked',disabled:true});btns.push('-');}
btns.push({process:MODx.config.connector_url?'resource/preview':'preview',text:_('view'),handler:this.preview,scope:this,id:'modx-abtn-preview'});btns.push('-');btns.push({process:'cancel',text:_('cancel'),handler:this.cancel,scope:this,id:'modx-abtn-cancel'});return btns;}});Ext.reg('collections-page-category-update',Collections.page.UpdateCategory);;Collections.panel.Category=function(config){config=config||{};MODx.config.confirm_navigation=0;Collections.panel.Category.superclass.constructor.call(this,config);};Ext.extend(Collections.panel.Category,MODx.panel.Resource,{getPageHeader:function(config){config=config||{record:{}};return{html:'<h2>'+_('collections.container_new')+'</h2>',id:'modx-resource-header',cls:'modx-page-header',border:false,forceLayout:true,anchor:'100%'};},getFields:function(config){var fields=Collections.panel.Category.superclass.getFields.call(this,config);var tabs=fields.filter(function(row){if(row.id=='modx-resource-tabs'){return row;}else{return false;}});if(tabs!=false&&tabs[0]){if(config.mode=='update'){tabs[0].items.unshift({title:_('collections.children'),id:'collections-category-resources',cls:'modx-resource-tab',layout:'form',labelAlign:'top',labelSeparator:'',bodyCssClass:'tab-panel-wrapper main-wrapper',autoHeight:true,defaults:{border:false,msgTarget:'under',width:400},items:this.getCollectionsChildrenTab(config)});}}
return fields;},getSettingFields:function(config){var fields=Collections.panel.Category.superclass.getSettingFields.call(this,config);fields.push([{layout:'column',border:false,anchor:'100%',defaults:{labelSeparator:'',labelAlign:'top',border:false,layout:'form',msgTarget:'under'},items:[{columnWidth:1,border:false,defaults:{msgTarget:'under'},items:[{xtype:'collections-combo-collections-template',fieldLabel:_('collections.template.template'),name:'collections_template',hiddenName:'collections_template',anchor:'100%',url:Collections.connectorUrl,baseParams:{action:'mgr/template/getlist',addEmpty:1}}]}]}]);return fields;},getCollectionsChildrenTab:function(config){return[{'xtype':'collections-grid-children',url:Collections.connectorUrl,anchor:'100%'}];}});Ext.reg('collections-panel-category',Collections.panel.Category);;Collections.grid.ContainerCollections=function(config){config=config||{};this.sm=new Ext.grid.CheckboxSelectionModel();Ext.applyIf(config,{id:'collections-grid-container-collections',title:_('collections.collections'),url:Collections.connectorUrl,autosave:true,save_action:'mgr/resource/updatefromgrid',ddGroup:'collectionChildDDGroup',enableDragDrop:false,baseParams:{action:'mgr/resource/getList',parent:MODx.request.id,sort:Collections.template.sort.field,dir:Collections.template.sort.dir},saveParams:{resource:MODx.request.id},fields:Collections.template.fields,paging:true,remoteSort:true,pageSize:Collections.template.pageSize,cls:'collections-grid',bodyCssClass:'grid-with-buttons',sm:this.sm,emptyText:_('collections.children.none'),columns:this.getColumns(config),tbar:this.getTbar(config)});Collections.grid.ContainerCollections.superclass.constructor.call(this,config);this.on('rowclick',MODx.fireResourceFormChange);this.on('click',this.handleButtons,this);if(Collections.template.allowDD){this.on('render',this.registerGridDropTarget,this);this.on('beforedestroy',this.destroyScrollManager,this);}};Ext.extend(Collections.grid.ContainerCollections,MODx.grid.Grid,{getMenu:function(){var m=[];if(!this.menu.record)return m;Ext.each(this.menu.record.actions,function(item){if(item.key=='delete'||item.key=='undelete'){m.push('-');}
m.push({text:_('collections.children.'+item.key),handler:'this.'+item.key+'Child'});},this);return m;},getColumns:function(config){var columns=Collections.template.columns;if(Collections.template.bulkActions){columns.unshift(this.sm);}
return columns;},getTbar:function(config){var items=[];if(Collections.template.resource_type_selection){var resourceDerivatives=[];Ext.each(Collections.resourceDerivatives,function(item){resourceDerivatives.push({text:item.name,derivative:item.id,handler:this.createDerivativeChild,scope:this});},this);items.push({text:_('collections.children.create'),handler:this.createChild,xtype:'splitbutton',scope:this,menu:resourceDerivatives});}else{items.push({text:_('collections.children.create'),handler:this.createChild,scope:this});}
if(Collections.template.bulkActions){items.push({text:_('bulk_actions'),xtype:'splitbutton',menu:[{text:_('collections.children.publish_multiple'),handler:this.publishSelected,scope:this},{text:_('collections.children.unpublish_multiple'),handler:this.unpublishSelected,scope:this},'-',{text:_('collections.children.delete_multiple'),handler:this.deleteSelected,scope:this},{text:_('collections.children.undelete_multiple'),handler:this.undeleteSelected,scope:this}]});}
items.push('->',{xtype:'collections-combo-filter-status',id:'collections-grid-filter-status',value:'',listeners:{'select':{fn:this.filterStatus,scope:this}}},{xtype:'textfield',name:'search',id:'collections-child-search',emptyText:_('search_ellipsis'),listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this.getValue());this.blur();return true;},scope:cmp});},scope:this}}},{xtype:'button',id:'modx-filter-clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}});return items;},filterStatus:function(cb,nv,ov){this.getStore().baseParams.filter=Ext.isEmpty(nv)||Ext.isObject(nv)?cb.getValue():nv;this.getBottomToolbar().changePage(1);this.refresh();return true;},search:function(tf,newValue,oldValue){var nv=newValue||tf;this.getStore().baseParams.query=Ext.isEmpty(nv)||Ext.isObject(nv)?'':nv;this.getBottomToolbar().changePage(1);this.refresh();return true;},clearFilter:function(){this.getStore().baseParams={action:'mgr/resource/getList','parent':MODx.request.id};Ext.getCmp('collections-child-search').reset();Ext.getCmp('collections-grid-filter-status').reset();this.getBottomToolbar().changePage(1);this.refresh();},editChild:function(btn,e){MODx.loadPage(MODx.request.a,'id='+this.menu.record.id);},createChild:function(btn,e){var template='';if(Collections.template.children.template!=null){template='&template='+Collections.template.children.template;}
MODx.loadPage(MODx.action['resource/create'],'parent='+MODx.request.id+'&context_key='+MODx.ctx+'&class_key='+Collections.template.children.resource_type+template);},createDerivativeChild:function(btn,e){var template='';if(Collections.template.children.template!=null){template='&template='+Collections.template.children.template;}
MODx.loadPage(MODx.action['resource/create'],'parent='+MODx.request.id+'&context_key='+MODx.ctx+'&class_key='+btn.derivative+template);},viewChild:function(btn,e){if(!this.menu.record.data){window.open(this.menu.record.preview_url);}else{window.open(this.menu.record.data.preview_url);}
return false;},duplicateChild:function(btn,e){var r={resource:this.menu.record.id,is_folder:false,name:_('duplicate_of',{name:this.menu.record.data.pagetitle})};var w=MODx.load({xtype:'modx-window-resource-duplicate',resource:this.menu.record.id,hasChildren:false,listeners:{'success':{fn:function(){this.refresh();},scope:this}}});w.config.hasChildren=false;w.setValues(r);w.show();return false;},deleteChild:function(btn,e){MODx.msg.confirm({title:_('collections.children.delete'),text:_('collections.children.delete_confirm'),url:this.config.url,params:{action:'mgr/resource/delete',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},deleteSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.msg.confirm({title:_('collections.children.delete_multiple'),text:_('collections.children.delete_multiple_confirm'),url:this.config.url,params:{action:'mgr/resource/deletemultiple',ids:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},undeleteSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/resource/undeletemultiple',ids:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},undeleteChild:function(btn,e){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/resource/undelete',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},publishSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/resource/publishmultiple',ids:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},unpublishSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/resource/unpublishmultiple',ids:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},publishChild:function(btn,e){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/resource/publish',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},unpublishChild:function(btn,e){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/resource/unpublish',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},handleButtons:function(e){var t=e.getTarget();var elm=t.className.split(' ')[0];if(elm=='controlBtn'){var action=t.className.split(' ')[1];var record=this.getSelectionModel().getSelected();this.menu.record=record;switch(action){case'delete':this.deleteChild();break;case'undelete':this.undeleteChild();break;case'edit':this.editChild();break;case'duplicate':this.duplicateChild();break;case'publish':this.publishChild();break;case'unpublish':this.unpublishChild();break;case'view':this.viewChild();break;default:window.location=record.data.edit_action;break;}}},getDragDropText:function(){if(this.config.baseParams.sort!='menuindex'){if(this.store.sortInfo==undefined||this.store.sortInfo.field!='menuindex'){return _('collections.err.bad_sort_column',{column:'menuindex'});}}
var search=Ext.getCmp('collections-child-search');var filter=Ext.getCmp('collections-grid-filter-status');if(search.getValue()!=''||filter.getValue()!=''){return _('collections.err.clear_filter');}
return _('collections.global.change_order',{child:this.selModel.selections.items[0].data.pagetitle});},getDragDropTextOverTree:function(){return _('collections.global.change_parent',{child:this.selModel.selections.items[0].data.pagetitle});},registerGridDropTarget:function(){this.getView().dragZone=new Ext.grid.GridDragZone(this,{ddGroup:'modx-treedrop-dd',originals:{},handleMouseDown:function(e){if(e.target.className=='x-grid3-row-checker'){return false;}
Ext.grid.GridDragZone.superclass.handleMouseDown.apply(this,arguments);return true;},onEndDrag:function(){var t=Ext.getCmp('modx-resource-tree');t.dropZone.appendOnly=false;t.dropZone.onNodeDrop=this.originals.onNodeDrop;t.dropZone.onNodeOver=this.originals.onNodeOver;t.on('nodedragover',t._handleDrop,t);t.on('beforenodedrop',t._handleDrop,t);return true;},onInitDrag:function(e){var data=this.dragData;this.ddel.innerHTML=this.grid.getDragDropText();this.proxy.update(this.ddel);var t=Ext.getCmp('modx-resource-tree');t.dropZone.appendOnly=true;t.removeListener('nodedragover',t._handleDrop);t.removeListener('beforenodedrop',t._handleDrop);this.originals.onNodeDrop=t.dropZone.onNodeDrop;this.originals.onNodeOver=t.dropZone.onNodeOver;t.dropZone.onNodeDrop=function(nodeData,source,e){MODx.Ajax.request({url:Collections.connectorUrl,params:{action:'mgr/resource/changeparent',id:source.dragData.selections[0].id,parent:nodeData.node.attributes.id},listeners:{'success':{fn:function(r){source.grid.refresh();return true;},scope:this}}});return true;};t.dropZone.onNodeOver=function(nodeData,source,e,data){source.ddel.innerHTML=source.grid.getDragDropTextOverTree();source.proxy.update(source.ddel);return this.dropAllowed;};return true;}});this.getView().dragZone.addToGroup('modx-treedrop-dd');this.getView().dragZone.addToGroup('collectionChildDDGroup');var ddrow=new Ext.ux.dd.GridReorderDropTarget(this,{copy:false,sortCol:'menuindex',listeners:{'beforerowmove':function(objThis,oldIndex,newIndex,records){},'afterrowmove':function(objThis,oldIndex,newIndex,records){MODx.Ajax.request({url:Collections.connectorUrl,params:{action:'mgr/resource/ddreorder',idItem:records.pop().id,oldIndex:oldIndex,newIndex:newIndex,parent:MODx.request.id},listeners:{'success':{fn:function(r){this.target.grid.refresh();},scope:this}}});},'beforerowcopy':function(objThis,oldIndex,newIndex,records){},'afterrowcopy':function(objThis,oldIndex,newIndex,records){}}});Ext.dd.ScrollManager.register(this.getView().getEditorParent());},destroyScrollManager:function(){Ext.dd.ScrollManager.unregister(this.getView().getEditorParent());}});Ext.reg('collections-grid-children',Collections.grid.ContainerCollections);;Collections.combo.FilterStatus=function(config){config=config||{};Ext.applyIf(config,{store:[['',_('collections.system.all')],['published',_('published')],['unpublished',_('unpublished')],['deleted',_('deleted')]],name:'filter',hiddenName:'filter',triggerAction:'all',editable:false,selectOnFocus:false,preventRender:true,forceSelection:true,enableKeyEvents:true});Collections.combo.FilterStatus.superclass.constructor.call(this,config);};Ext.extend(Collections.combo.FilterStatus,MODx.combo.ComboBox);Ext.reg('collections-combo-filter-status',Collections.combo.FilterStatus);Collections.combo.Template=function(config,getStore){config=config||{};Ext.applyIf(config,{name:'fake_templates',hiddenName:'fake_templates',displayField:'templatename',valueField:'id',fields:['templatename','id'],mode:'remote',triggerAction:'all',typeAhead:true,editable:true,forceSelection:false,clearBtnCls:'x-form-trigger',expandBtnCls:'x-form-trigger',pageSize:20,url:Collections.config.connectorUrl,baseParams:{action:'mgr/extra/gettemplates',template:(MODx.request.id!=undefined)?MODx.request.id:0}});Ext.applyIf(config,{store:new Ext.data.JsonStore({url:config.url,root:'results',totalProperty:'total',fields:config.fields,errorReader:MODx.util.JSONReader,baseParams:config.baseParams||{},remoteSort:config.remoteSort||false,autoDestroy:true})});if(getStore===true){config.store.load();return config.store;}
Collections.combo.Template.superclass.constructor.call(this,config);this.config=config;return this;};Ext.extend(Collections.combo.Template,Ext.ux.form.SuperBoxSelect);Ext.reg('collections-combo-template',Collections.combo.Template);Collections.combo.SortDir=function(config){config=config||{};Ext.applyIf(config,{store:[['asc',_('sort_asc')],['desc',_('sort_desc')]],name:'sortdir',hiddenName:'sortdir',editable:false,selectOnFocus:false,preventRender:true,forceSelection:true,enableKeyEvents:true});Collections.combo.SortDir.superclass.constructor.call(this,config);};Ext.extend(Collections.combo.SortDir,MODx.combo.ComboBox);Ext.reg('collections-combo-sort-dir',Collections.combo.SortDir);Collections.combo.CollectionsTemplate=function(config){config=config||{};Ext.applyIf(config,{name:'collections_template',hiddenName:'collections_template',displayField:'name',valueField:'id',fields:['name','id'],pageSize:20,url:Collections.config.connectorUrl,baseParams:{action:'mgr/template/getlist'}});Collections.combo.CollectionsTemplate.superclass.constructor.call(this,config);};Ext.extend(Collections.combo.CollectionsTemplate,MODx.combo.ComboBox);Ext.reg('collections-combo-collections-template',Collections.combo.CollectionsTemplate);Collections.combo.SingleTemplate=function(config){config=config||{};Ext.applyIf(config,{name:'resource_template',hiddenName:'resource_template',displayField:'templatename',valueField:'id',fields:['templatename','id'],pageSize:20,url:Collections.config.connectorUrl,baseParams:{action:'mgr/extra/gettemplates'}});Collections.combo.SingleTemplate.superclass.constructor.call(this,config);};Ext.extend(Collections.combo.SingleTemplate,MODx.combo.ComboBox);Ext.reg('collections-combo-single-template',Collections.combo.SingleTemplate);;Ext.ux.dd.GridReorderDropTarget=function(grid,config){this.target=new Ext.dd.DropTarget(grid.getEl(),{ddGroup:grid.ddGroup||'GridDD',grid:grid,sortCol:'menuindex',gridDropTarget:this,notifyDrop:function(dd,e,data){if(data.grid.config.baseParams.sort!=this.sortCol){if(data.grid.store.sortInfo==undefined||data.grid.store.sortInfo.field!=this.sortCol){return false;}}
var search=Ext.getCmp('collections-child-search');var filter=Ext.getCmp('collections-grid-filter-status');if(search!=undefined&&filter!=undefined){if(search.getValue()!=''||filter.getValue()!=''){return false;}}
var t=Ext.lib.Event.getTarget(e);var rindex=this.grid.getView().findRowIndex(t);if(rindex===false)return false;if(rindex==data.rowIndex)return false;var menuIndexes={};menuIndexes.oldIndex=this.grid.store.data.items[data.rowIndex].data[this.sortCol];menuIndexes.newIndex=this.grid.store.data.items[rindex].data[this.sortCol];if(this.gridDropTarget.fireEvent(this.copy?'beforerowcopy':'beforerowmove',this.gridDropTarget,menuIndexes.oldIndex,menuIndexes.newIndex,data.selections)===false)return false;var ds=this.grid.getStore();if(!this.copy){for(i=0;i<data.selections.length;i++){ds.remove(ds.getById(data.selections[i].id));}}
ds.insert(rindex,data.selections);var sm=this.grid.getSelectionModel();if(sm)sm.selectRecords(data.selections);this.gridDropTarget.fireEvent(this.copy?'afterrowcopy':'afterrowmove',this.gridDropTarget,menuIndexes.oldIndex,menuIndexes.newIndex,data.selections);return true;},notifyOver:function(dd,e,data){this.grid.getView().dragZone.ddel.innerHTML=this.grid.getDragDropText();this.grid.getView().dragZone.proxy.update(this.grid.getView().dragZone.ddel);if(data.grid.config.baseParams.sort!=this.sortCol){if(data.grid.store.sortInfo==undefined||data.grid.store.sortInfo.field!=this.sortCol){return this.dropNotAllowed;}}
var search=Ext.getCmp('collections-child-search');var filter=Ext.getCmp('collections-grid-filter-status');if(search!=undefined&&filter!=undefined){if(search.getValue()!=''||filter.getValue()!=''){return this.dropNotAllowed;}}
var t=Ext.lib.Event.getTarget(e);var rindex=this.grid.getView().findRowIndex(t);if(rindex==data.rowIndex)rindex=false;return(rindex===false)?this.dropNotAllowed:this.dropAllowed;}});if(config){Ext.apply(this.target,config);if(config.listeners)Ext.apply(this,{listeners:config.listeners});}
this.addEvents({"beforerowmove":true,"afterrowmove":true,"beforerowcopy":true,"afterrowcopy":true});Ext.ux.dd.GridReorderDropTarget.superclass.constructor.call(this);};Ext.extend(Ext.ux.dd.GridReorderDropTarget,Ext.util.Observable,{getTarget:function(){return this.target;},getGrid:function(){return this.target.grid;},getCopy:function(){return this.target.copy?true:false;},setCopy:function(b){this.target.copy=b?true:false;}});;var pagetitleWithButtons=new Ext.XTemplate('<tpl for="."><div class="collections-title-column">'
+'<h3 class="main-column buttons"><a href="{action_edit}" title="Edit {pagetitle}">{pagetitle}</a></h3>'
+'<tpl if="actions">'
+'<ul class="actions">'
+'<tpl for="actions">'
+'<li><a href="#" class="controlBtn {className}">{text}</a></li>'
+'</tpl>'
+'</ul>'
+'</tpl>'
+'</div></tpl>',{compiled:true});var pagetitle=new Ext.XTemplate('<tpl for="."><div class="collections-title-column">'
+'<h3 class="main-column"><a href="{action_edit}" title="Edit {pagetitle}">{pagetitle}</a></h3>'
+'</div></tpl>',{compiled:true});Collections.renderer.qtip=function(value,metaData,record,rowIndex,colIndex,store){metaData.attr='ext:qtip="'+value+'"';return value;};Collections.renderer.pagetitleWithButtons=function(value,metaData,record,rowIndex,colIndex,store){return pagetitleWithButtons.apply(record.data);};Collections.renderer.pagetitle=function(value,metaData,record,rowIndex,colIndex,store){return pagetitle.apply(record.data);};Collections.renderer.pagetitleLink=function(value,metaData,record,rowIndex,colIndex,store){return'<a href="'+record.data.action_edit+'" title="Edit '+value+'">'+value+'</a>';};Collections.renderer.datetimeTwoLines=function(value,metaData,record,rowIndex,colIndex,store){if(value==0)return'';var d=Date.parseDate(value,'Y-m-d H:i:s');var date=Ext.util.Format.date(d,MODx.config['collections.mgr_date_format']);var time=Ext.util.Format.date(d,MODx.config['collections.mgr_time_format']);return'<div class="collections-grid-date">'+date+'<span class="collections-grid-time">'+time+'</span></div>';};Collections.renderer.datetime=function(value,metaData,record,rowIndex,colIndex,store){if(value==0)return'';var d=Date.parseDate(value,'Y-m-d H:i:s');return Ext.util.Format.date(d,MODx.config['collections.mgr_datetime_format']);};